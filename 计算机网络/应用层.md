# 应用层

### 概述

为应用程序的通信提供服务

#### 应用层协议定义

+ 应用进程交换的报文类型，请求还是响应
+ 各种报文类型的语法，如报文中的各个字段以及详细描述
+ 字段的语义，即包含在字段中的信息的含义
+ 进程何时、如何发送报文，以及对报文的响应的规则

#### 功能

+ 文件传输、访问和管理
+ 电子邮件
+ 虚拟终端
+ 查询服务和远程作业登录

#### 重要协议

+ FTP
+ SMTP、POP3
+ HTTP
+ DNS

### 网络应用模型

#### C/S客户端服务器模型

<img src="/Users/zhanzhiguo/Library/Containers/com.tencent.WeWorkMac/Data/Library/Application Support/WXWork/Temp/ScreenCapture/企业微信截图_7d5c2e70-3d4a-453b-9b0a-e2b51a5ca7ab.png" alt="企业微信截图_7d5c2e70-3d4a-453b-9b0a-e2b51a5ca7ab" style="zoom:50%;" />

#### P2P

<img src="/Users/zhanzhiguo/Library/Containers/com.tencent.WeWorkMac/Data/Library/Application Support/WXWork/Temp/ScreenCapture/企业微信截图_c75aba1b-be19-46e2-baed-990145532639.png" alt="企业微信截图_c75aba1b-be19-46e2-baed-990145532639" style="zoom:50%;" />



### DNS系统

#### 域名服务器

+ 根域名服务器：13台根服务器，从a.root-servers.net到m.root-servers.net，会有很多台主机共用一个根服务器域名

  包含了所有顶级域名服务器的域名和IP地址，首先查看顶级域名例如.com然后将顶级域名服务器的IP地址返回给本地域名服务器

  或者逐层的查找直到查找到域名对应的IP地址

+ 顶级域名服务器：.com、.net

  管理该顶级域名服务器注册的所有二级域名

+ 权限域名服务器

  负责一个区的域名服务器，对于某个公司的域名abc.com，负责该区下的主机的域名解析，如果还有子域名y.abc.com，就会将该子域名单独作为一个区，需要一台独立的域名服务器

+ 本地域名服务器

  当一个主机发出DNS查询请求时，这个查询请求报文发给本地域名服务器，一半本地域名服务器离主机时最近的

  如果本地域名服务器没有有关域名的映射关系，转发给根域名服务器

#### 递归查询

+ 主机查询本地域名服务器
+ 如果本地域名服务器无法解析，向根域名服务器求助解析
+ 根域名服务器根据顶级域名，向对应的顶级域名服务器寻求解析
+ 如果顶级域名服务器无法解析，继续向权限域名服务器解析
+ 查询到IP地址后，向上传递给主机

#### 迭代查询

+ 主机查询本地域名服务器
+ 如果本地域名服务器无法解析，向根域名服务器求助解析
+ 根域名服务器返回对应的顶级域名服务器的IP地址，然后由本地域名服务器向顶级域名服务器解析
+ 如果顶级域名服务器无法解析，继续返回下层的权限域名服务器IP地址
+ 返回IP地址

#### 高速缓存

缓存以及查询过的域名和IP的映射地址

### HTTPS

> HTTP默认端口为80，HTTPS默认端口为443，但是443端口只是用于加密协商过程，最终的数据传送过程依然在80端口上
>
> 而且，443端口不能被修改，只要使用了https协议，默认端口都是443

### Q & A

#### 全球DNS根服务器为什么只有13台？

> UDP能保证正常工作的最大包长是512字节（超出部分会被截断），因为在DNS解析时使用的UDP协议，因此如果要传输所有根DNS服务器的数据都放在一个包中，根服务器的数量只能限制在13个，
>
> 当我们查询根域（.）（默认每个域名的顶级域名都会有一个英文句号.作为根域名）的NS记录时，512字节只够返回13个根域名服务器的NS记录和A记录的响应

1994年，全世界共有9台根域名服务器，DNS响应已经十分接近UDP的512字节的极限，这9台的DNS响应报文的大小为389字节

根据RFC 791规定，为保证UDP数据包传输成功率，尽量数据包控制在571字节使数据包不会被分片传输，再出去UDP数据包自身包头占用的字节数，DNS数据包被设计为不超过512字节

**数据包各部分字节占用**

+ Header部分占用12个字节

  + Transaction ID：2字节
  + Flags
  + Questions
  + Answer RRs
  + Authority RRs
  + Additional RRs

+ Question Section：5字节

  + 根标签：1字节
  + Class：2字节，基本都是IN
  + 查询类型：2字节

+ Answer Section：所有记录字节数之和

  + 每条记录包括根标签1字节、TTL4字节、Class2字节、查询类型2字节，域名存储占用的字节数

  + 域名在DNS解析协议中按照长度2字节+数据的形式存储，其中数据部分分段存储，例如

    <img src="/Users/zhanzhiguo/Library/Containers/com.tencent.WeWorkMac/Data/Library/Application Support/WXWork/Temp/ScreenCapture/企业微信截图_ab6e47f0-3f04-4c6a-abf2-15f413116fbf.png" alt="企业微信截图_ab6e47f0-3f04-4c6a-abf2-15f413116fbf" style="zoom:67%;" />

    所以第一条记录域名存储占用22个字节，总共占用9+22=31个字节

    第二条记录开始因为我记录中出现的域名存在部分内容与第一条记录重复（root-servers.net），因此只需要利用DNS指针压缩，存储，存储2个字节的指针即可，指向第一条记录出现的部分，而不需要存储实际内容，所以第二条记录之后的记录占用的字节数分别为11+4=15个字节

+ Additional Section：占用的字节数为所有记录字节数之和

  每条记录包括域名、TTL4字节、Class2字节、查询类型2字节，IP地址2字节长度+4字节内容，因为Additional Section记录的域名在Answer Section中都出现过，所以这部分可以利用DNS指针压缩存储，只需要存储2个字节的指针即可表示对应的域名，所以AS部分的记录占用的字节数为2+4+2+2+6=16字节

由上面数据包组成可以得到数据包总长度为12+5+31+15*（n-1）+16*n<=512得到n不能超过15组，考虑预留一些缓存，因此只搭建了13台根域名服务器

#### 根域名服务器的数量问题——DNS的任播

> DNS是任播最成功的应用，今天所有的根域名的服务器都部署在任播上，节点遍布全球
>
> 全球共有1089个根域名服务器节点，由12个组织负责运营。我国一共有26个根域名服务器节点
>
> IPv6中国一共部署了4台根域名服务器，1台主根和3台辅根

#### DNS中的TCP和UDP

**区域传送时使用TCP**

+ 辅域名服务器会定时向主域名服务器进行查询一遍了解数据是否有变动，有变动则会执行一次区域传送，执行数据同步。区域传送将使用TCP而不是UDP，因为数据同步传送的数据量比一个请求和应答的数据量要很多

**域名解析时使用UDP**

+ 客户端向DNS服务器查询域名，一半返回的内容不会超过512字节，用UDP传输，不需要TCP的三次握手，可以降低DNS服务器的负载
+ 虽然客户端也可以指定向服务器查询的时候使用TCP，但是很多DNS服务器进行配置时仅支持UDP查询包









































